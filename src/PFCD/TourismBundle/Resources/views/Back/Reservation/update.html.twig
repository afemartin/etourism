{% extends 'PFCDTourismBundle:Back:layout.html.twig' %}

{% form_theme edit_form 'PFCDTourismBundle:Form:fields.html.twig' %}

{% set sectiontab = 'reservation' %}{% set helptooltip = 1 %}{% set datepicker = 1 %}

{% block body %}
<h1>{{ 'back.reservation.update.title'|trans }}</h1>
<p>{{ 'back.reservation.update.subtitle'|trans }}</p>

<div class="well">
    <h3>{{ 'front.reservation.summary.title'|trans }}:</h3>
    <hr style="margin-top: 0"/>
    <p><b>{{ 'front.reservation.summary.activity'|trans }}</b>: {{ reservation.session.activity.title }}</p>
    <p><b>{{ 'front.reservation.summary.sessiondate'|trans }}</b>: {{ reservation.session.date|date('Y-m-d') }}</p>
    <p><b>{{ 'front.reservation.summary.sessiontime'|trans }}</b>: {% if reservation.session.time %}{{ reservation.session.time|date('H:i') }}{% else %}{{ 'front.reservation.summary.sessiontime.undefined'|trans }}{% endif %}</p>
    <p><b>{{ 'front.reservation.summary.availability'|trans }}</b>: {{ capacity }}</p>
</div>

{% if error %}
<div class="alert alert-error fade in"><button class="close" data-dismiss="alert">Ã—</button>{{ 'alert.error.reservation.invalidsession'|trans }}</div>
{% endif %}

<form class="form-horizontal" action="{{ path('back_reservation_update', { 'id': reservation.id }) }}" method="post" {{ form_enctype(edit_form) }}>
    {{ form_widget(edit_form) }}
    <div class="form-actions">
        <button class="btn btn-success" type="submit"><i class="icon-ok icon-white"></i> {{ 'Save changes'|trans }}</button>
        <a class="btn btn-inverse" href="{{ path('back_reservation_read', { 'id': reservation.id }) }}"><i class="icon-remove icon-white"></i> {{ 'Cancel changes'|trans }}</a>
        <span class='field-required-desc'>*</span> <b>{{ 'form.field.required.help'|trans }}</b>
    </div>
</form>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        $('#reservation_session').after('<div class="control-group"><label for="reservation_session" class="control-label">{{ 'Session'|trans }}</label><div id="reservation_calendar" class="controls"></div></div>')
        getCalendar({{ reservation.session.activity.id }}, {{ reservation.session.date|date('Y') }}, {{ reservation.session.date|date('m') }});
        
        function getCalendar(id, year, month)
        {
            if ($('#calendar_header').length > 0)
            {
                $('#calendar_prev_month').attr('onclick', 'return false');
                $('#calendar_prev_month').attr('disabled', 'disabled');
                $('#calendar_next_month').attr('onclick', 'return false');
                $('#calendar_next_month').attr('disabled', 'disabled');
                $('#calendar_header').html('<i class="icon-loading" style="vertical-align:middle"></i> {{ 'Loading'|trans }}...');
                $('#calendar_table').css({ opacity: 0.75 });
            }
            else
            {    
                $('#reservation_calendar').prepend('<i class="icon-loading"></i> {{ 'Loading'|trans }}...');
            }
            
            $.ajax({
                type: "GET",
                data: "id=" + id + "&year=" + year + "&month=" + month,
                url: "{{ path('back_activity_calendar') }}",
                success: function(calendar) {
                    $('#reservation_calendar').html(calendar);
                    selectSession({{ reservation.session.id}});
                }
            });
        }
        
        function selectSession(id)
        {
            document.getElementById('reservation_session').value = id;
            $('.calendar .label.active').removeClass('active');
            $('.session'+id).addClass('active');
        }
    </script>
{% endblock %}